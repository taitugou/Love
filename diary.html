<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç•™è¨€å¢™ Â· å†°å†°æˆ‘çˆ±ä½ </title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#ff6b9a;
      --muted:#9aa4b2;
      --glass: rgba(255,255,255,0.04);
      --watch-size: 360px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{
      background: linear-gradient(180deg,#071021 0%, #071827 60%);
      display:flex;align-items:center;justify-content:center;padding:20px;color:#e6eef8;
    }

    /* å°å‹æ‰‹è¡¨å®¹å™¨ */
    .watch {
      width: var(--watch-size);
      max-width:92vw;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 28px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
      padding: 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    .header {
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
    }
    .title {
      display:flex;align-items:center;gap:10px;
    }
    .logo {
      width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ff9cc2);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:18px;
      box-shadow:0 6px 18px rgba(255,107,154,0.18);
    }
    .title h1{margin:0;font-size:16px;letter-spacing:0.2px;}
    .subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    /* message list */
    .list {
      width:100%;
      max-height:320px;
      overflow:auto;
      padding:8px;
      display:flex;flex-direction:column-reverse;gap:8px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }
    .msg {
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:10px;border-radius:10px;background:var(--glass);
      border:1px solid rgba(255,255,255,0.02);
    }
    .msg .left{display:flex;align-items:center;gap:10px;}
    .avatar {
      width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#ffd1e0,#ff9cc2);
      /* éšè—å¤´åƒï¼šä¸æ˜¾ç¤ºé¦–å­—æ¯ç”Ÿæˆçš„å¤´åƒ */
      display:none !important;
      font-weight:700;color:#3b0b1a;font-size:14px;
    }
    .content {font-size:14px;color:#eaf3ff;}
    .meta {font-size:11px;color:var(--muted);margin-top:4px;}

    .actions {display:flex;gap:8px;align-items:center;}
    .btn {
      background:transparent;border:0;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px;
    }
    .btn:hover{background:rgba(255,255,255,0.02);color:#fff;}

    /* input area */
    .composer {
      width:100%;display:flex;gap:8px;align-items:center;
    }
    input[type="text"]{
      flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      background:transparent;color:inherit;font-size:14px;outline:none;
    }
    .send {
      background:linear-gradient(180deg,var(--accent),#ff8fb0);border:0;color:#fff;padding:10px 14px;border-radius:12px;
      cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(255,107,154,0.18);
    }
    .send:active{transform:translateY(1px);}

    /* log */
    pre#log{width:100%;height:60px;overflow:auto;background:transparent;border-radius:8px;color:var(--muted);font-size:12px;padding:8px;margin:0;border:1px dashed rgba(255,255,255,0.02);}

    /* heart effect */
    .heart {
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;
      font-size:28px;opacity:0;filter:drop-shadow(0 6px 18px rgba(255,107,154,0.25));
    }
    .heart.fly {
      animation: flyUp 1200ms ease-out forwards;
    }
    @keyframes flyUp {
      0% { transform:translate(-50%, -10%) scale(0.6); opacity:1; }
      40% { transform:translate(-50%, -60%) scale(1.1); opacity:1; }
      100% { transform:translate(-50%, -180%) scale(0.8); opacity:0; }
    }

    /* big message */
    .big-love {
      position:fixed;left:50%;top:12%;transform:translateX(-50%);z-index:40;
      font-size:28px;color:var(--accent);font-weight:800;opacity:0;pointer-events:none;
      text-shadow:0 6px 30px rgba(255,107,154,0.12);
    }
    .big-love.show { animation: pop 900ms cubic-bezier(.2,.9,.3,1) forwards; }
    @keyframes pop {
      0% { transform:translateX(-50%) scale(0.6); opacity:0; }
      40% { transform:translateX(-50%) scale(1.08); opacity:1; }
      100% { transform:translateX(-50%) scale(1); opacity:1; }
    }

    /* responsive small watch */
    @media (max-width:420px){
      :root{--watch-size: 360px;}
      .logo{width:40px;height:40px}
      .title h1{font-size:15px}
    }
  </style>
</head>
<body>
  <div class="watch" role="application" aria-label="ç•™è¨€å¢™">
    <div class="header">
      <div class="title">
        <div class="logo">ğŸ’–</div>
        <div>
          <h1>å†°å†°ç•™è¨€å¢™</h1>
        </div>
      </div>
    </div>

    <div class="list" id="msgList" aria-live="polite"></div>

    <div class="composer">
      <input id="content" type="text" placeholder="å†™ç‚¹è¯ç»™è€€è€€..." maxlength="200" />
      <button id="sendBtn" class="send">å‘</button>
    </div>

    <div id="pagination" class="pagination" aria-label="åˆ†é¡µ"></div>
  </div>

  <div class="heart" id="heart">ğŸ’–</div>
  <div class="big-love" id="bigLove">å†°å†° æˆ‘çˆ±ä½ ï¼</div>

<script>
  // ---------- é…ç½® ----------
  const SUPABASE_URL = "https://sxqtvpqiemncvqppanms.supabase.co";
  const SUPABASE_KEY = "sb_publishable_hnj-Fg4a63aZtkEXXBBcGw_W6ZEuw0e";

  // ---------- åˆå§‹åŒ– ----------
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const msgList = document.getElementById('msgList');
  const contentEl = document.getElementById('content');
  const sendBtn = document.getElementById('sendBtn');
  const paginationEl = document.getElementById('pagination');
  const heartEl = document.getElementById('heart');
  const bigLoveEl = document.getElementById('bigLove');

  // åˆ†é¡µå’Œè®¡æ•°
  const pageSize = 9;
  let currentPage = 1;
  let totalCount = 0;

  function log(msg){
    const t = new Date().toLocaleTimeString();
    console.log(`[${t}] ${msg}`);
  }

  // æ¸²æŸ“å•æ¡æ¶ˆæ¯
  function renderMessage(row, hideAvatar = false){
    const div = document.createElement('div');
    div.className = 'msg';
    div.dataset.id = row.id;
    if (hideAvatar) div.dataset.noavatar = '1';
    const left = document.createElement('div'); left.className = 'left';
    const avatar = document.createElement('div'); avatar.className = 'avatar';
    avatar.textContent = (row.content || '').slice(0,1) || 'å†°';
    if (hideAvatar) avatar.style.display = 'none';
    const contentWrap = document.createElement('div');
    const contentText = document.createElement('div'); contentText.className = 'content';
    contentText.textContent = row.content;
    const meta = document.createElement('div'); meta.className = 'meta';
    meta.textContent = new Date(row.created_at).toLocaleString();
    contentWrap.appendChild(contentText); contentWrap.appendChild(meta);
    left.appendChild(avatar); left.appendChild(contentWrap);

    const actions = document.createElement('div'); actions.className = 'actions';
    const delBtn = document.createElement('button'); delBtn.className = 'btn'; delBtn.title='åˆ é™¤';
    delBtn.innerHTML = 'ğŸ—‘';
    delBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm('ç¡®è®¤åˆ é™¤è¿™æ¡ç•™è¨€ï¼Ÿ')) return;
      try {
        const { error } = await supabaseClient.from('messages').delete().eq('id', row.id);
        if (error) {
          log('åˆ é™¤å¤±è´¥: ' + JSON.stringify(error));
        } else {
          log('å·²åˆ é™¤ id=' + row.id);
          // ç«‹å³ä» UI ä¸­ç§»é™¤ï¼Œä¸åˆ·æ–°é¡µé¢æˆ–é‡æ–°è¯»å–å…¨éƒ¨ç•™è¨€
          removeMessageFromUI(row.id);
        }
      } catch (err) {
        log('åˆ é™¤å¼‚å¸¸: ' + err.message);
      }
    });

    actions.appendChild(delBtn);
    div.appendChild(left); div.appendChild(actions);
    return div;
  }

  // æ¸…ç©ºå¹¶æ¸²æŸ“å½“å‰é¡µï¼ˆæŒ‰æ—¶é—´é™åºï¼‰ï¼Œæ”¯æŒåˆ†é¡µ
  async function loadMessages(page = 1){
    currentPage = page;
    try {
      const start = (page - 1) * pageSize;
      const end = start + pageSize - 1;
      const { data, error, count } = await supabaseClient
        .from('messages')
        .select('*', { count: 'exact' })
        .order('id', { ascending: false })
        .range(start, end);
      if (error) {
        log('åŠ è½½å¤±è´¥: ' + JSON.stringify(error));
        return;
      }
      totalCount = count ?? (Array.isArray(data) ? data.length : 0);
      msgList.innerHTML = '';
      for (const row of data) {
        const node = renderMessage(row);
        msgList.appendChild(node);
      }
      buildPagination();
      log('å·²åŠ è½½ ' + (data ? data.length : 0) + ' æ¡ç•™è¨€ (ç¬¬' + page + 'é¡µ)');
    } catch (err) {
      log('åŠ è½½å¼‚å¸¸: ' + err.message);
    }
  }

  // æ·»åŠ å•æ¡åˆ° UIï¼ˆæ’å…¥åˆ°é¡¶éƒ¨ï¼‰
  // fromRealtime: å¦‚æœä¸º trueï¼Œåˆ™è¡¨ç¤ºè¿™æ¬¡æ’å…¥æ¥è‡ª realtime äº‹ä»¶ï¼ˆä¸åº”ä¿®æ”¹æ€»æ•°ï¼‰
  function addMessageToUI(row, options = {}){
    const { fromRealtime = false, hideAvatar = false } = options;
    // å¦‚æœå·²å­˜åœ¨åˆ™å…ˆè¯»å–æ˜¯å¦éšè— avatarï¼Œç„¶åç§»é™¤æ—§çš„
    const existing = msgList.querySelector(`[data-id="${row.id}"]`);
    let preserveNoAvatar = false;
    if (existing) {
      preserveNoAvatar = existing.dataset.noavatar === '1';
      existing.remove();
    }
    const useHide = preserveNoAvatar || hideAvatar;
    // ä»…å½“å½“å‰é¡µä¸ºç¬¬ä¸€é¡µæ—¶å°†æœ€æ–°æ¶ˆæ¯æ’å…¥åˆ°é¡¶éƒ¨ä»¥ä¾¿ç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°
    if (currentPage === 1) {
      const node = renderMessage(row, useHide);
      msgList.insertBefore(node, msgList.firstChild);
      // ä¿æŒå½“å‰é¡µæ•°é‡ä¸è¶…è¿‡ pageSize
      const items = msgList.querySelectorAll('.msg');
      if (items.length > pageSize) items[items.length - 1].remove();
    }
    if (!fromRealtime) totalCount++;
    buildPagination();
  }

  // ç§»é™¤ UIï¼ˆåˆ é™¤æˆåŠŸåè°ƒç”¨ï¼‰
  function removeMessageFromUI(id){
    const el = msgList.querySelector(`[data-id="${id}"]`);
    if (el) {
      el.remove();
      totalCount = Math.max(0, totalCount - 1);
    }
    buildPagination();
    // å¦‚æœå½“å‰é¡µå·²ç©ºä¸”ä¸æ˜¯ç¬¬ä¸€é¡µï¼Œåˆ™åŠ è½½å‰ä¸€é¡µä»¥ä¿æŒæ˜¾ç¤ºï¼ˆä»…åœ¨å¿…è¦æ—¶è§¦å‘é‡æ–°è¯»å–å½“å‰é¡µï¼‰
    if (msgList.children.length === 0 && currentPage > 1) {
      loadMessages(currentPage - 1);
    }
  }

  // æ›´æ–°å·²æœ‰æ¶ˆæ¯ï¼ˆæ¥è‡ª realtime çš„ UPDATEï¼‰
  function updateMessageInUI(row){
    const el = msgList.querySelector(`[data-id="${row.id}"]`);
    if (el) {
      const contentText = el.querySelector('.content');
      const meta = el.querySelector('.meta');
      if (contentText) contentText.textContent = row.content;
      if (meta) meta.textContent = new Date(row.created_at).toLocaleString();
    } else {
      // å¦‚æœä¸åœ¨å½“å‰é¡µï¼Œåˆ™åœ¨éœ€è¦æ—¶æ’å…¥ï¼ˆä¸æ”¹å˜æ€»æ•°ï¼Œå› ä¸ºè¿™æ˜¯æ›´æ–°ï¼‰
      addMessageToUI(row, { fromRealtime: true });
    }
  }

  // æ„å»ºåˆ†é¡µæ§ä»¶
  function buildPagination(){
    const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
    paginationEl.innerHTML = '';
    const prev = document.createElement('button'); prev.textContent = 'ä¸Šä¸€é¡µ'; prev.className = 'btn'; prev.disabled = currentPage <= 1; prev.addEventListener('click', () => { if (currentPage>1) loadMessages(currentPage-1); });
    paginationEl.appendChild(prev);

    const maxButtons = 7;
    if (totalPages <= maxButtons) {
      for (let p = 1; p <= totalPages; p++) {
        const b = document.createElement('button'); b.textContent = p; b.className = 'btn'; if (p === currentPage) { b.disabled = true; b.style.fontWeight = '700'; }
        b.addEventListener('click', () => loadMessages(p));
        paginationEl.appendChild(b);
      }
    } else {
      const createPageBtn = (p) => { const b = document.createElement('button'); b.textContent = p; b.className = 'btn'; if (p === currentPage) { b.disabled = true; b.style.fontWeight = '700'; } b.addEventListener('click', () => loadMessages(p)); paginationEl.appendChild(b); };
      createPageBtn(1);
      if (currentPage > 4) { const ell = document.createElement('span'); ell.textContent = '...'; ell.style.margin = '0 6px'; paginationEl.appendChild(ell); }
      const start = Math.max(2, currentPage - 2);
      const end = Math.min(totalPages - 1, currentPage + 2);
      for (let p = start; p <= end; p++) createPageBtn(p);
      if (currentPage < totalPages - 3) { const ell = document.createElement('span'); ell.textContent = '...'; ell.style.margin = '0 6px'; paginationEl.appendChild(ell); }
      createPageBtn(totalPages);
    }

    const next = document.createElement('button'); next.textContent = 'ä¸‹ä¸€é¡µ'; next.className = 'btn'; next.disabled = currentPage >= totalPages; next.addEventListener('click', () => { if (currentPage<totalPages) loadMessages(currentPage+1); });
    paginationEl.appendChild(next);
  }

  // å‘é€çˆ±å¿ƒç‰¹æ•ˆä¸å¤§å­—
  function triggerLoveEffects(){
    // heart fly
    heartEl.classList.remove('fly');
    void heartEl.offsetWidth;
    heartEl.classList.add('fly');

    // big love
    bigLoveEl.classList.remove('show');
    void bigLoveEl.offsetWidth;
    bigLoveEl.classList.add('show');
    setTimeout(()=> bigLoveEl.classList.remove('show'), 1800);
  }

  // å‘é€æ¶ˆæ¯
  sendBtn.addEventListener('click', async () => {
    const content = contentEl.value.trim();
    if (!content) { log('å†…å®¹ä¸ºç©º'); return; }
    sendBtn.disabled = true;
    sendBtn.textContent = 'å‘é€ä¸­...';
    log('å¼€å§‹æ’å…¥...');
    try {
      // å¿…é¡»ä¼ æ•°ç»„å¹¶åŠ  .select() æ‰è¿”å›æ’å…¥åçš„è¡Œ
      const { data, error } = await supabaseClient
        .from('messages')
        .insert([{ content }])
        .select();
      if (error) {
        log('æ’å…¥å¤±è´¥: ' + JSON.stringify(error));
      } else {
        log('æ’å…¥æˆåŠŸ: ' + JSON.stringify(data));
        contentEl.value = '';
        triggerLoveEffects();
        // UI ä¼šç”± realtime è‡ªåŠ¨æ·»åŠ ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ç«‹å³æ’å…¥ä»¥è·å¾—æ›´å¿«åé¦ˆ
        // å‘é€è€…çš„æœ¬åœ°æ’å…¥ä¸æ˜¾ç¤ºå¤´åƒï¼ˆhideAvatarï¼‰
        if (Array.isArray(data) && data.length) addMessageToUI(data[0], { hideAvatar: true });
      }
    } catch (err) {
      log('æ’å…¥å¼‚å¸¸: ' + err.message);
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'å‘';
    }
  });

  // å›è½¦å‘é€
  contentEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // ---------- realtime ç›‘å¬ ----------
  // ä½¿ç”¨ postgres_changes ç›‘å¬ INSERT / DELETE / UPDATE
  const channel = supabaseClient.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
      const row = payload.new;
      log('Realtime: æ–°å¢ id=' + row.id);
      // æ¥è‡ª realtime çš„æ’å…¥ä¸åº”æ”¹å˜ totalCountï¼ˆæˆ‘ä»¬åœ¨æœ¬åœ°æ’å…¥æ—¶ä¼šå·²æ›´æ–°æ€»æ•°ï¼‰
      addMessageToUI(row, { fromRealtime: true });
    })
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'messages' }, payload => {
      const id = payload.old.id;
      log('Realtime: åˆ é™¤ id=' + id);
      removeMessageFromUI(id);
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages' }, payload => {
      const row = payload.new;
      log('Realtime: æ›´æ–° id=' + row.id);
      // æ›´æ–°ç°æœ‰å…ƒç´ ï¼ˆä¸æ”¹å˜æ€»æ•°ï¼‰
      updateMessageInUI(row);
    })
    .subscribe(status => {
      log('Realtime è®¢é˜…çŠ¶æ€: ' + JSON.stringify(status));
    });

  // ---------- å¯åŠ¨æ—¶åŠ è½½ ----------
  (async function init(){
    log('åˆå§‹åŒ–ä¸­...');
    await loadMessages();
    log('åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…å®æ—¶æ›´æ–°...');
  })();

  // æ¸…ç†ï¼ˆé¡µé¢å¸è½½æ—¶å–æ¶ˆè®¢é˜…ï¼‰
  window.addEventListener('beforeunload', () => {
    try { supabaseClient.removeChannel(channel); } catch(e){}
  });
</script>
</body>
</html>
