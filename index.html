<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>ä¸€ç›´åœ¨æƒ³ä½ </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#a57bff">
<style>
  :root {
    /* é«˜çº§æ·¡ç´«è‰²ï¼ˆåŠ æ·±ç‰ˆï¼‰ï¼šä¿ç•™æŸ”å’Œæ„Ÿä½†å¢åŠ é¥±å’Œä¸å¯¹æ¯”ä»¥æ˜¾é«˜çº§ï¼‰ */
    --color-main: #dcc6f8; /* æ¯”ä¹‹å‰æ›´æ·±çš„è–°è¡£è‰ */
    --color-accent: #a57bff; /* æ›´é¥±å’Œçš„ä¸»è‰²ç”¨äºæŒ‰é’®å’Œé‡ç‚¹ */
    --color-glow: #b993ff; /* æ¸©å’Œå‘å…‰è‰²ï¼Œåäº®ç”¨äºå…‰æ™• */
    --color-deep: #48284d; /* æ›´æ·±çš„ç´«è‰²ä½œä¸ºå¯¹æ¯”è‰² */
    --color-white: #ffffff;
    --color-pink: #ff7fb3; /* æ·±ä¸€ç‚¹çš„ç‚¹ç¼€ç²‰ */
    --color-shadow1: rgba(165,123,255,0.9);
    --color-shadow2: rgba(149,103,238,0.75);
    /* æ–‡å­—è‰²å½©ï¼šä¸»æ–‡æœ¬ä¸å¼±åŒ–æ–‡æœ¬ã€é’è‰²å¼ºè°ƒ */
    --color-text: #3b233f; /* ä¸»æ–‡æœ¬ï¼šæ·±ç´«ï¼Œå¢å¼ºå¯è¯»æ€§ */
    --color-text-muted: rgba(72,40,77,0.72);
    --color-cyan: #9feaff; /* æ—¶é—´/æ ‡ç­¾ç­‰å¼ºè°ƒè‰² */
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    height: auto;
    overflow-y: auto;
    /* å•è‰²é«˜çº§ç´«èƒŒæ™¯ä»¥ä¿è¯é«˜è´¨æ„Ÿå’Œä¸€è‡´æ€§ï¼ˆç§»é™¤æ¸å˜ï¼‰ */
    background: var(--color-main);
    font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "STKaiti", "Segoe UI", Arial, cursive, sans-serif;
    color: var(--color-text);
  }

  body { position: relative; overflow-y: auto; overscroll-behavior: none; }

  .floating-button {
    position: fixed;
    padding: 10px 16px;
    font-size: 1.05em;
    font-weight: 700;
    color: var(--color-white);
    border: none;
    border-radius: 999px;
    cursor: pointer;
    z-index: 12;
    transition: transform .22s ease, box-shadow .22s ease, opacity .22s ease;
    will-change: transform, box-shadow, opacity;
    backdrop-filter: blur(6px);
  }

  .draw-button {
    left: 50%;
    bottom: 88px;
    transform: translateX(-50%);
    background: linear-gradient(90deg, var(--color-accent), var(--color-accent)); /* kept simple for compatibility */
    background-color: var(--color-accent);
    box-shadow: 0 6px 30px var(--color-shadow1);
    color: var(--color-white);
  }
  .draw-button:hover { transform: translateX(-50%) scale(1.06); box-shadow: 0 8px 40px var(--color-shadow1); }

  .note-button { right: 20px; bottom: 20px; background: rgba(165,123,255,0.18); box-shadow: 0 6px 28px rgba(149,103,238,0.28); }
  .note-button:hover { transform: scale(1.05); box-shadow: 0 10px 38px rgba(149,103,238,0.38); }

  .diary-button { left: 20px; bottom: 20px; background: rgba(165,123,255,0.16); box-shadow: 0 6px 28px rgba(165,123,255,0.22); }
  .diary-button:hover { transform: scale(1.05); box-shadow: 0 10px 38px rgba(165,123,255,0.34); }

  #bgCanvas, #particleCanvas {
    position: fixed; left: 0; top: 0; z-index: 0;
    width: 100vw !important; height: 100vh !important; display: block; pointer-events: none;
  }

  .stars-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
    /* ä½¿ç”¨æ·¡ç´«è‰²æ˜Ÿç‚¹ï¼Œæ€§èƒ½å‹å¥½ä¸”ç¬¦åˆå•è‰²ä¸»é¢˜ */
    background:
      radial-gradient(2px 2px at 20px 30px, rgba(165,123,255,0.95), transparent),
      radial-gradient(2px 2px at 40px 70px, rgba(149,103,238,0.9), transparent);
    background-repeat: repeat; background-size: 200px 100px; opacity: 0.22;
    animation: twinkle 4s infinite alternate;
  }
  @keyframes twinkle { 0%,100% { opacity: 0.2; } 50% { opacity: 0.4; } }

  .main-content {
    position: relative; margin: 20px auto; width: 90%; max-width: 800px; text-align: center;
  }

  .love-saying {
    font-size: 3.2em; font-weight: 800; color: var(--color-accent); letter-spacing: .08em;
    padding-bottom: .08em; text-shadow: 0 0 24px var(--color-glow), 0 0 12px rgba(0,0,0,0.5);
    animation: romancePulse 1.8s infinite cubic-bezier(.6,0,.4,1);
    margin-bottom: 0.6em; cursor: pointer; transition: transform .22s ease;
    -webkit-text-fill-color: unset;
  }
  .love-saying:hover { transform: scale(1.05); }
  @keyframes romancePulse { 0% { transform:translateY(0) scale(1);} 45%{ transform:translateY(-12px) scale(1.12);} 100%{transform:translateY(0) scale(1);} }

  .love-time {
    padding: 0.9em 0.6em; border-radius: 14px; background: rgba(0,0,0,0.08);
    box-shadow: 0 6px 28px rgba(20,0,30,0.6) inset;
    mix-blend-mode: normal; transition: transform .22s ease; animation: floatText 3.6s ease-in-out infinite alternate;
    display: block; position: relative; overflow: hidden;
    -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    background-color: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06); width: 100%; box-sizing: border-box; margin-bottom: 1.1em; pointer-events: none;
  }

  .time-line { display:flex; justify-content:center; align-items:center; margin:0.35em 0; line-height:1.1; }
  .time-line.spacing-small { height: 0.5em; }

  .time-label { font-size:1.2em; font-weight:600; color:var(--color-deep); text-shadow:0 0 8px rgba(0,0,0,0.04); margin-right:0.5em; }
  .love-time .time-line:first-child .time-label { font-size:2em; color:var(--color-pink); text-shadow:0 0 15px var(--color-pink); margin-right:0; }

  .time-value { font-weight:800; color:var(--color-deep); text-shadow:0 1px 0 rgba(255,255,255,0.04); }
  .days-value { font-size:3.2em; } .hours-value { font-size:1.6em; } .minutes-value { font-size:1.6em; } .seconds-value { font-size:1.2em; } .milliseconds-value { font-size:0.9em; }

  @keyframes floatText { 0%{transform:translateY(0);} 40%{transform:translateY(-6px);} 100%{transform:translateY(0);} }

  .heart-container { position:relative; width:100%; height:150px; display:flex; justify-content:center; align-items:center; margin-top:0.25em; cursor:pointer; }
  .heart { position:absolute; width:120px; height:108px; animation:heartbeat 0.9s infinite cubic-bezier(.2,.8,.2,1); filter: drop-shadow(0 0 30px var(--color-glow)); z-index:2; transform-origin:center; transition:transform .18s ease; }
  .heart:hover { transform: scale(1.1); }
  .heart svg { width:100%; height:100%; fill: var(--color-pink); filter: drop-shadow(0 0 18px rgba(255,127,179,0.9)); }
  @keyframes heartbeat { 0%{transform:scale(1);}5%{transform:scale(1.1);}10%{transform:scale(1.15);}15%{transform:scale(1.2);}50%{transform:scale(1);}100%{transform:scale(1);} }
  .heart-pulse { position:absolute; width:180px; height:180px; border-radius:50%; background:radial-gradient(circle at 40% 30%, rgba(165,123,255,0.28), rgba(149,103,238,0.08)); animation:pulse 1.2s infinite; z-index:1; transform-origin:center; }
  @keyframes pulse { 0%{transform:scale(0.8);opacity:0.7;}50%{transform:scale(1.2);opacity:0.3;}100%{transform:scale(1.4);opacity:0;} }

  .diary-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; opacity:0; pointer-events:none; transition:opacity 0.3s; }
  .diary-modal.active { opacity:1; pointer-events:auto; }
  .diary-content {
    background: rgba(30,0,50,0.95); border-radius:20px; padding:30px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto;
    box-shadow:0 0 50px rgba(0,255,255,0.5); border:2px solid rgba(255,255,255,0.2);
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); background-color: rgba(30,0,50,0.95);
  }
  .diary-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px; }
  .diary-title { font-size:1.8em; color:var(--color-cyan); margin:0; }
  .diary-close { background:none; border:none; color:white; font-size:1.5em; cursor:pointer; }

  .diary-week-navigation, .diary-day-navigation { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .diary-nav-button { background:rgba(0,255,255,0.6); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; transition:all 0.3s; }
  .diary-nav-button:hover { background:rgba(0,255,255,0.9); }
  .diary-nav-button:disabled { opacity:0.5; cursor:not-allowed; }
  .diary-week-title, .diary-day-title { font-size:1.2em; color:var(--color-cyan); }

  .diary-heart-line { margin:8px 0 12px; color:var(--color-pink); font-weight:700; }
  .diary-text { color:white; white-space:pre-wrap; line-height:1.6; }

  .note-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; opacity:0; pointer-events:none; transition:opacity 0.3s; }
  .note-modal.active { opacity:1; pointer-events:auto; }
  .note-content {
    background: linear-gradient(0deg, rgba(20,6,30,0.94), rgba(20,6,30,0.94)); border-radius:14px; padding:20px; width:92%; max-width:520px; max-height:78vh; overflow-y:auto;
    box-shadow:0 10px 60px rgba(80,30,120,0.28); border:1px solid rgba(255,255,255,0.04);
    -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
  }
  .note-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px; }
  .note-title { font-size:1.8em; color:var(--color-pink); margin:0; }
  .close-button { background:none; border:none; color:white; font-size:1.5em; cursor:pointer; padding:5px; }

  .week-navigation { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .nav-button { background:rgba(255,107,157,0.6); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; transition:all 0.3s; }
  .nav-button:hover { background:rgba(255,107,157,0.9); }
  .nav-button:disabled { opacity:0.5; cursor:not-allowed; }
  .week-title { font-size:1.2em; color:var(--color-cyan); }
  .note-list { list-style:none; padding:0; margin:0; }
  .note-item { padding:15px; margin-bottom:10px; background:rgba(255,255,255,0.1); border-radius:10px; border-left:4px solid var(--color-pink); }
  .note-date { font-weight:bold; color:var(--color-cyan); margin-bottom:5px; }
  .note-text { color:white; }

  .fullscreen-effect { position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:100; opacity:0; transition:opacity 0.22s; }
  .fullscreen-effect.active { opacity:1; }
  .fullscreen-effect .effect-bg { position:absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(165,123,255,0.9) 0%, rgba(72,40,77,0.92) 100%); animation:effectBgPulse 2.6s ease-out forwards; }
  @keyframes effectBgPulse { 0%{transform:scale(0);opacity:0;}20%{transform:scale(1);opacity:1;}80%{transform:scale(1);opacity:1;}100%{transform:scale(1.2);opacity:0;} }
  .fullscreen-effect .effect-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2em; max-width:90%; color:white; text-shadow:0 0 40px rgba(255,255,255,0.9); animation:effectTextPulse 3s ease-out forwards; z-index:101; text-align:center; font-weight:bold; white-space:normal; word-break:break-word; line-height:1.4; }
  @keyframes effectTextPulse { 0%{transform:translate(-50%,-50%) scale(0);opacity:0;}30%{transform:translate(-50%,-50%) scale(1.2);opacity:1;}50%{transform:translate(-50%,-50%) scale(1);opacity:1;}70%{transform:translate(-50%,-50%) scale(1.1);opacity:1;}100%{transform:translate(-50%,-50%) scale(1.2);opacity:0;} }

  .title-svg { width:100%; height:64px; overflow:visible; display:block; }
  .spacing-small { height:0.5em; }

  @media (max-width: 768px) {
    .main-content { width:95%; }
    .love-saying { font-size:2.6em; }
    .love-time { padding:1em 0.5em; }
    .days-value { font-size:2.6em; } .hours-value { font-size:1.4em; } .minutes-value { font-size:1.4em; } .seconds-value { font-size:1.1em; } .milliseconds-value { font-size:1em; }
    .heart { width:120px; height:108px; } .heart-pulse { width:150px; height:150px; }
    .fullscreen-effect .effect-text { font-size:3em; }
    .floating-button { font-size:1.1em; padding:10px 20px; bottom:20px; }
  }
  /* æå°å± / æ‰‹è¡¨ 320px åŠä»¥ä¸‹çš„ä½“éªŒä¼˜åŒ– */
  @media (max-width: 480px) {
    .love-saying { font-size:2em; }
    /* æ›´ç´§å‡‘çš„è®¡æ—¶æ˜¾ç¤ºï¼Œéšè—æ¯«ç§’ä»¥èŠ‚èƒ½ */
    .days-value { font-size:2.2em; } .hours-value { font-size:1.3em; } .minutes-value { font-size:1.3em; } .seconds-value { font-size:1.1em; } .milliseconds-value { display:none; }
    .time-label { font-size:1em; }
    .heart { width:100px; height:90px; } .heart-pulse { width:130px; height:130px; }
    .fullscreen-effect .effect-text { font-size:2em; }
    .floating-button { font-size:0.9em; padding:6px 12px; bottom:10px; }
    .note-content { padding:20px; }
  }
  /* è¶…ç´§å‡‘ï¼šé€‚é…æ™ºèƒ½æ‰‹è¡¨æˆ–éå¸¸å°çš„å±å¹• */
  @media (max-width: 320px) {
    .fullscreen-effect .effect-text { font-size:1.2em; max-width:95%; }
    .heart { width:70px; height:60px; } .heart-pulse { width:96px; height:96px; } .love-saying { font-size:1.4em; }
    .floating-button { font-size:0.78em; padding:4px 8px; bottom:6px; }
  }

  ::-webkit-scrollbar { display: none; }
</style>
</head>
<body>
  <div class="stars-background"></div>
  <canvas id="bgCanvas"></canvas>
  <canvas id="particleCanvas"></canvas>

  <div class="fullscreen-effect" id="fullscreenEffect">
    <div class="effect-bg"></div>
    <div class="effect-text" id="effectText">ğŸ’–</div>
  </div>

  <div class="note-modal" id="noteModal">
    <div class="note-content">
      <div class="note-header">
        <h2 class="note-title">æƒ³ä½ çš„æ¯ä¸€å¤© ğŸ’Œ</h2>
        <button type="button" class="close-button" id="closeNote">âœ•</button>
      </div>

      <div class="week-navigation">
        <button type="button" class="nav-button" id="prevWeek">ä¸Šä¸€å‘¨</button>
        <div class="week-title" id="weekTitle">ç¬¬1å‘¨</div>
        <button type="button" class="nav-button" id="nextWeek">ä¸‹ä¸€å‘¨</button>
      </div>

      <ul class="note-list" id="noteList"></ul>
    </div>
  </div>

  <div class="main-content">
    <div class="love-saying" id="loveSaying">
      <svg class="title-svg" viewBox="0 0 360 64" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <!-- Removed gradient: use currentColor for a solid title color -->
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="28" font-weight="700" font-family="-apple-system, BlinkMacSystemFont, 'PingFang SC', 'STKaiti', 'Segoe UI', Arial, sans-serif" fill="currentColor">
          TaiTugouåœ¨æƒ³è€å©†
        </text>
      </svg>
    </div>

    <div class="love-time" id="loveTime">
      <div class="time-line">
        <span class="time-label">æƒ³ä½ äº†</span>
      </div>
      <div class="time-line spacing-small"></div>
      <div class="time-line">
        <span class="time-value days-value" id="days">0</span>
        <span class="time-label">å¤©</span>
      </div>
      <div class="time-line">
        <span class="time-value hours-value" id="hours">00</span>
        <span class="time-label">å°æ—¶</span>
      </div>
      <div class="time-line">
        <span class="time-value minutes-value" id="minutes">00</span>
        <span class="time-label">åˆ†é’Ÿ</span>
      </div>
      <div class="time-line">
        <span class="time-value seconds-value" id="seconds">00</span>
        <span class="time-label">ç§’</span>
      </div>
      <div class="time-line">
        <span class="time-value milliseconds-value" id="milliseconds">000</span>
        <span class="time-label">æ¯«ç§’</span>
      </div>
    </div>

    <div class="heart-container" id="heartContainer">
      <div class="heart-pulse"></div>
      <div class="heart">
        <svg viewBox="0 0 32 29.6">
          <path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z"></path>
        </svg>
      </div>
    </div>
  </div>

  <button type="button" class="note-button floating-button" id="noteButton">æ‰“å¡ä¾¿ç­¾ ğŸ’</button>
  <button type="button" class="diary-button floating-button" id="diaryButton">æ—¥è®°ä¾¿ç­¾ ğŸ“˜</button>
  <button type="button" class="draw-button floating-button" id="drawButton">è€å©†ç•™è¨€ ğŸ˜˜</button>

  <div class="diary-modal" id="diaryModal">
    <div class="diary-content">
      <div class="diary-header">
        <h2 class="diary-title">æ¯å‘¨æ—¥è®°</h2>
        <button type="button" class="diary-close" id="diaryClose">âœ•</button>
      </div>

      <div class="diary-week-navigation">
        <button type="button" class="diary-nav-button" id="diaryPrevWeek">ä¸Šä¸€å‘¨</button>
        <div class="diary-week-title" id="diaryWeekTitle">ç¬¬1å‘¨</div>
        <button type="button" class="diary-nav-button" id="diaryNextWeek">ä¸‹ä¸€å‘¨</button>
      </div>

      <div class="diary-day-navigation">
        <button type="button" class="diary-nav-button" id="diaryPrevDay">ä¸Šä¸€å¤©</button>
        <div class="diary-day-title" id="diaryDayTitle">æ˜ŸæœŸæ—¥</div>
        <button type="button" class="diary-nav-button" id="diaryNextDay">ä¸‹ä¸€å¤©</button>
      </div>

      <div class="diary-heart-line" id="diaryHearts">æƒ³è€å©†æŒ‡æ•°ï¼š</div>
      <div class="diary-text" id="diaryText">æš‚æ— æ—¥è®°</div>
    </div>
  </div>

<script>
  const CONFIG = { startDate: "2025-10-18T13:28:07" };

  const dailyMessages = [
    "å‘¨ä¸€ï¼šæ²¡æƒ³åˆ°æ¯å¤©ä¸ä¸€æ ·å§ï¼Œæ–°çš„ä¸€å‘¨å¼€å§‹äº†ï¼Œæ›´åŠ æƒ³ä½ äº†ğŸ’•",
    "å‘¨äºŒï¼šè·ç¦»å‘¨æœ«åˆè¿‘äº†ä¸€å¤©ï¼ŒæœŸå¾…è§åˆ°ä½ âœ¨",
    "å‘¨ä¸‰ï¼šä¸€å‘¨è¿‡åŠï¼Œæ€å¿µå´è¶Šæ¥è¶Šæµ“ğŸŒ¹",
    "å‘¨å››ï¼šå¿«è¦è§åˆ°ä½ äº†ï¼Œå¿ƒæƒ…å¼€å§‹æ¿€åŠ¨ğŸŒŸ",
    "å‘¨äº”ï¼šæ˜å¤©ä¸­åˆå°±èƒ½ç›¸è§äº†ï¼Œæ— æ¯”æœŸå¾…ğŸ’–",
    "å‘¨å…­ï¼šç»ˆäºç­‰åˆ°è¿™ä¸€å¤©ğŸ‰",
    "å‘¨æ—¥ï¼šçæƒœå’Œä½ åœ¨ä¸€èµ·çš„æ¯ä¸€åˆ†æ¯ä¸€ç§’ğŸ’"
  ];

  const state = {
    currentWeek: 0,
    currentDay: 0,
    diaryEntries: [],
    effectTimeout: null,
    notes: JSON.parse(localStorage.getItem('loveNotes')) || []
  };

  const elements = {
    bgCanvas: document.getElementById('bgCanvas'),
    particleCanvas: document.getElementById('particleCanvas'),
    fullscreenEffect: document.getElementById('fullscreenEffect'),
    effectText: document.getElementById('effectText'),
    loveSaying: document.getElementById('loveSaying'),
    days: document.getElementById('days'),
    hours: document.getElementById('hours'),
    minutes: document.getElementById('minutes'),
    seconds: document.getElementById('seconds'),
    milliseconds: document.getElementById('milliseconds'),
    heartContainer: document.getElementById('heartContainer'),
    noteButton: document.getElementById('noteButton'),
    noteModal: document.getElementById('noteModal'),
    closeNote: document.getElementById('closeNote'),
    noteList: document.getElementById('noteList'),
    prevWeek: document.getElementById('prevWeek'),
    nextWeek: document.getElementById('nextWeek'),
    weekTitle: document.getElementById('weekTitle'),
    diaryButton: document.getElementById('diaryButton'),
    diaryModal: document.getElementById('diaryModal'),
    diaryClose: document.getElementById('diaryClose'),
    diaryPrevWeek: document.getElementById('diaryPrevWeek'),
    diaryNextWeek: document.getElementById('diaryNextWeek'),
    diaryWeekTitle: document.getElementById('diaryWeekTitle'),
    diaryPrevDay: document.getElementById('diaryPrevDay'),
    diaryNextDay: document.getElementById('diaryNextDay'),
    diaryDayTitle: document.getElementById('diaryDayTitle'),
    diaryHearts: document.getElementById('diaryHearts'),
    diaryText: document.getElementById('diaryText'),
    drawButton: document.getElementById('drawButton')
  };

  function init() {
    setupBackground();
    setupParticles();
    setupEventListeners();
    generateAllNotes();
    state.currentWeek = Math.max(0, Math.ceil(state.notes.length / 7) - 1);
    updateWeekDisplay();
    startTimer();
  }

  function setupBackground() {
    const bgCtx = elements.bgCanvas.getContext('2d');
    function resizeBgCanvas() {
      elements.bgCanvas.width = window.innerWidth;
      elements.bgCanvas.height = window.innerHeight;
    }
    resizeBgCanvas();
    window.addEventListener('resize', resizeBgCanvas);
    function drawBackground() {
      const w = elements.bgCanvas.width, h = elements.bgCanvas.height;
      const gradient = bgCtx.createLinearGradient(0,0,w,h);
  // æ›´åŠ é¥±å’Œã€åæ·±çš„æ·¡ç´«æ¸å˜ä»¥å¢å¼ºè´¨æ„Ÿ
  gradient.addColorStop(0,"#f3ecff"); gradient.addColorStop(0.3,"#eadbff"); gradient.addColorStop(0.7,"#dcc6f8"); gradient.addColorStop(1,"#cbb0f0");
      bgCtx.fillStyle = gradient; bgCtx.fillRect(0,0,w,h);
      requestAnimationFrame(drawBackground);
    }
    drawBackground();
  }

  function setupParticles() {
    const pCtx = elements.particleCanvas.getContext('2d');
    let dpr = window.devicePixelRatio || 1;
    function resizeParticleCanvas() {
      const w = window.innerWidth, h = window.innerHeight;
      elements.particleCanvas.width = w * dpr;
      elements.particleCanvas.height = h * dpr;
      elements.particleCanvas.style.width = w + 'px';
      elements.particleCanvas.style.height = h + 'px';
      pCtx.setTransform(1,0,0,1,0,0);
      pCtx.scale(dpr, dpr);
    }
    resizeParticleCanvas();
    window.addEventListener('resize', resizeParticleCanvas);
    function drawParticles() {
      pCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      const centerX = window.innerWidth/2;
      const centerY = window.innerHeight/2 - 45;
      const size = Math.min(window.innerWidth, window.innerHeight) * 0.03;
      pCtx.beginPath();
      for (let t=0; t<=2*Math.PI; t+=0.01) {
        const x = 16 * Math.pow(Math.sin(t),3);
        const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
        pCtx.lineTo(centerX + x*size, centerY + y*size);
      }
      pCtx.closePath();
  // ä½¿ç”¨æ›´é¥±å’Œçš„æ·¡ç´«æè¾¹ï¼ŒåŒ¹é…åŠ æ·±åçš„ä¸»é¢˜
  pCtx.strokeStyle = 'rgba(149,103,238,0.55)';
      pCtx.lineWidth = 2;
      pCtx.stroke();
      requestAnimationFrame(drawParticles);
    }
    drawParticles();
  }

  function setupEventListeners() {
    elements.drawButton = document.getElementById('drawButton');
elements.drawButton.addEventListener('click', () => {
  window.location.href = './diary.html';
});
    elements.heartContainer.addEventListener('click', showHeartEffect);
    elements.heartContainer.addEventListener('touchstart', showHeartEffect, { passive:true });
    elements.loveSaying.addEventListener('click', showDailyMessage);
    elements.loveSaying.addEventListener('touchstart', showDailyMessage, { passive:true });

    elements.noteButton.addEventListener('click', openNoteModal);
    elements.closeNote.addEventListener('click', closeNoteModal);
    elements.prevWeek.addEventListener('click', showPrevWeek);
    elements.nextWeek.addEventListener('click', showNextWeek);
    elements.noteModal.addEventListener('click', (e)=> { if (e.target === elements.noteModal) closeNoteModal(); });

    elements.diaryButton.addEventListener('click', openDiaryModal);
    elements.diaryClose.addEventListener('click', closeDiaryModal);
    elements.diaryModal.addEventListener('click', (e)=> { if (e.target === elements.diaryModal) closeDiaryModal(); });
    elements.diaryPrevWeek.addEventListener('click', async ()=> {
      if (diaryState.currentWeek > 1) {
        diaryState.currentWeek--;
        await loadDiaryWeek(diaryState.currentWeek);
        diaryState.currentDayIndex=0;
        renderDiaryWeekHeader();
        renderDiaryDay();
      }
    });
    elements.diaryNextWeek.addEventListener('click', async ()=> {
      diaryState.currentWeek++;
      await loadDiaryWeek(diaryState.currentWeek);
      diaryState.currentDayIndex=0;
      renderDiaryWeekHeader();
      renderDiaryDay();
    });
    elements.diaryPrevDay.addEventListener('click', ()=> { if (diaryState.currentDayIndex>0) { diaryState.currentDayIndex--; renderDiaryDay(); }});
    elements.diaryNextDay.addEventListener('click', ()=> { if (diaryState.currentDayIndex<6) { diaryState.currentDayIndex++; renderDiaryDay(); }});
  }

  let heartClickCount = 0;
  function showHeartEffect() {
    heartClickCount++;
    const base = document.getElementById('fullscreenEffect'); if (!base) return;
    const clone = base.cloneNode(true); clone.id = ''; clone.classList.add('active');
    const textEl = clone.querySelector('.effect-text');
    if (heartClickCount >= 10) { if (textEl) textEl.textContent = 'è€å©†ï¼Œç­‰æˆ‘å›å®¶ğŸ˜­'; heartClickCount = 0; } else { if (textEl) textEl.textContent = 'ğŸ’–'; }
    document.body.appendChild(clone);
    setTimeout(()=>{ try { clone.remove(); } catch(e){} }, 2200);
  }

  function showDailyMessage() {
    const today = new Date(); const dayOfWeek = today.getDay();
    const messageIndex = dayOfWeek === 0 ? dailyMessages.length - 1 : dayOfWeek - 1;
    const dailyMessage = dailyMessages[messageIndex] || '';
    const base = document.getElementById('fullscreenEffect'); if (!base) return;
    const clone = base.cloneNode(true); clone.id = ''; clone.classList.add('active');
    const textEl = clone.querySelector('.effect-text'); if (textEl) textEl.textContent = dailyMessage;
    document.body.appendChild(clone);
    setTimeout(()=>{ try { clone.remove(); } catch(e){} }, 4200);
  }

  function startTimer() {
    const startTime = new Date(CONFIG.startDate).getTime();
    function updateTimer() {
      const now = Date.now(); const diff = now - startTime;
      const days = Math.floor(diff / (1000*60*60*24));
      const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
      const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
      const seconds = Math.floor((diff % (1000*60)) / 1000);
      const milliseconds = diff % 1000;
      elements.days.textContent = days;
      elements.hours.textContent = String(hours).padStart(2,'0');
      elements.minutes.textContent = String(minutes).padStart(2,'0');
      elements.seconds.textContent = String(seconds).padStart(2,'0');
      elements.milliseconds.textContent = String(milliseconds).padStart(3,'0');
      requestAnimationFrame(updateTimer);
    }
    updateTimer();
  }

  function generateAllNotes() {
    const startDate = new Date(CONFIG.startDate); const today = new Date(); const notes = [];
    let currentDate = new Date(startDate);
    while (currentDate <= today) {
      const year = currentDate.getFullYear(); const month = currentDate.getMonth()+1; const date = currentDate.getDate();
      const day = currentDate.getDay(); const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const diffTime = Math.abs(currentDate - startDate);
      const diffDays = Math.ceil(diffTime / (1000*60*60*24));
      const dateStr = `${year}å¹´${month}æœˆ${date}æ—¥ æ˜ŸæœŸ${dayNames[day]}`;
      const noteText = `ä»Šå¤©${month}æœˆ${date}æ—¥æ˜ŸæœŸ${dayNames[day]}ï¼Œæƒ³è€å©†çš„ç¬¬${diffDays}å¤©`;
      notes.push({ date: dateStr, text: noteText, timestamp: currentDate.getTime() });
      currentDate.setDate(currentDate.getDate() + 1);
    }
    state.notes = notes;
    localStorage.setItem('loveNotes', JSON.stringify(state.notes));
  }

  function openNoteModal() { updateWeekDisplay(); elements.noteModal.classList.add('active'); }
  function closeNoteModal() { elements.noteModal.classList.remove('active'); }
  function showPrevWeek() { if (state.currentWeek > 0) { state.currentWeek--; updateWeekDisplay(); } }
  function showNextWeek() {
    const totalWeeks = Math.ceil(state.notes.length / 7);
    if (state.currentWeek < totalWeeks - 1) { state.currentWeek++; updateWeekDisplay(); }
  }

  function updateWeekDisplay() {
    const startIndex = state.currentWeek * 7; const endIndex = startIndex + 7;
    const weekNotes = state.notes.slice(startIndex, endIndex);
    elements.weekTitle.textContent = `ç¬¬${state.currentWeek + 1}å‘¨`;
    elements.prevWeek.disabled = state.currentWeek === 0;
    const totalWeeks = Math.ceil(state.notes.length / 7);
    elements.nextWeek.disabled = state.currentWeek >= totalWeeks - 1;
    elements.noteList.innerHTML = '';
    if (weekNotes.length === 0) {
      const emptyItem = document.createElement('li'); emptyItem.className = 'note-item'; emptyItem.innerHTML = '<div class="note-text">æš‚æ— è®°å½•</div>'; elements.noteList.appendChild(emptyItem);
    } else {
      weekNotes.forEach(note => {
        const noteItem = document.createElement('li'); noteItem.className = 'note-item';
        noteItem.innerHTML = `<div class="note-date">${note.date}</div><div class="note-text">${note.text}</div>`;
        elements.noteList.appendChild(noteItem);
      });
    }
  }

  // ------------------------
  // å‘¨æ—¥è®°è§£æä¸ä¿®å¤
  // æ¯ä¸ªå¤§æ‹¬å·å—è¡¨ç¤ºä¸€å¤©ï¼Œæ”¯æŒæ ¼å¼ï¼š
  // {love:(5)
  // message:(æ–‡æœ¬ï¼Œå¯ä»¥å¤šè¡Œ)
  // }
  // ä¹Ÿå…¼å®¹æ²¡æœ‰å¤§æ‹¬å·ä½†ç”¨ --- åˆ†å‰²æˆ–æ•´ä¸ªæ–‡ä»¶åªä¸€æ®µçš„æƒ…å†µ
  // ------------------------
  const WEEKDAY_NAMES = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
  const diaryState = { currentWeek: 1, currentDayIndex: 0, weekEntries: [], lastLoadedRaw: null };

  function computeCurrentWeekFromTimer() {
    const start = new Date(CONFIG.startDate).getTime();
    const now = Date.now();
    const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
    return Math.floor(days / 7) + 1;
  }

  // æ›´ç¨³å¥çš„ loadDiaryWeekï¼šå¹¶è¡Œå°è¯• 1-based ä¸ 0-based URLï¼Œç¦ç”¨ç¼“å­˜ï¼Œä¾æ®å“åº”çŠ¶æ€å†³å®šä½¿ç”¨å“ªä¸ª
  async function loadDiaryWeek(weekNumber) {
    try {
      const indexOneBased = Number(weekNumber);
      const indexZeroBased = indexOneBased - 1;
      const baseUrl = './md/';
      const urlOne = `${baseUrl}${indexOneBased}.md?ts=${Date.now()}`;
      const urlZero = `${baseUrl}${indexZeroBased}.md?ts=${Date.now()}`;

      // å¹¶è¡Œå‘èµ·è¯·æ±‚ï¼ˆä¸ç¼“å­˜ï¼‰
      const fetchOptions = { cache: 'no-store', redirect: 'follow' };

      const p1 = fetch(urlOne, fetchOptions).then(r => ({ ok: r.ok, status: r.status, text: () => r.text() })).catch(e => ({ ok:false, status:0, text: async ()=>'' }));
      const p0 = fetch(urlZero, fetchOptions).then(r => ({ ok: r.ok, status: r.status, text: () => r.text() })).catch(e => ({ ok:false, status:0, text: async ()=>'' }));

      const [res1, res0] = await Promise.all([p1, p0]);

      let raw = null;
      let usedUrl = null;

      // ä¼˜å…ˆä½¿ç”¨ 1-based æœ‰æ•ˆè¿”å›
      if (res1.ok) {
        raw = await res1.text();
        usedUrl = urlOne;
      } else if (res0.ok) {
        // å¦‚æœ 1-based æ— æ•ˆä½† 0-based æœ‰ï¼Œä½¿ç”¨ 0-basedï¼ˆå…¼å®¹æ—§å‘½åï¼‰
        raw = await res0.text();
        usedUrl = urlZero;
      } else {
        // ä¸¤è€…éƒ½ä¸å¯ç”¨ï¼šè®¾ç½®é»˜è®¤å¹¶é€€å‡º
        diaryState.weekEntries = Array.from({ length: 7 }, () => ({ score: 0, text: 'æš‚æ— æ—¥è®°' }));
        diaryState.lastLoadedRaw = null;
        return;
      }

      // è‹¥åŠ è½½åˆ°çš„ raw ä¸ä¸Šæ¬¡åŠ è½½ç›¸åŒä½† weekNumber ä¸å˜ï¼Œåˆ™æ­£å¸¸ï¼›è‹¥ä¸åŒ weekNumber å´ç›¸åŒå†…å®¹ï¼Œè§†ä¸ºä¸å¯é ï¼Œå›é€€é»˜è®¤
      if (diaryState.lastLoadedRaw && diaryState.lastLoadedRaw === raw && diaryState.lastRequestedWeek && diaryState.lastRequestedWeek !== indexOneBased) {
        // å¦‚æœä¸åŒå‘¨è¯·æ±‚ä½†å†…å®¹ä¸ä¸Šæ¬¡ç›¸åŒï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨è¿”å›å ä½é¡µæˆ–è·¯ç”±é‡å®šå‘ï¼Œä½¿ç”¨é»˜è®¤é˜²æ­¢é”™é…
        diaryState.weekEntries = Array.from({ length: 7 }, () => ({ score: 0, text: 'æš‚æ— æ—¥è®°' }));
        diaryState.lastLoadedRaw = null;
        diaryState.lastRequestedWeek = null;
        return;
      }

      diaryState.lastLoadedRaw = raw;
      diaryState.lastRequestedWeek = indexOneBased;

      // æå–æ‰€æœ‰ { ... } å—ï¼›æ¯ä¸ªå¤§æ‹¬å·ä¸ºä¸€å¤©
      let blocks = [...raw.matchAll(/\{([\s\S]*?)\}/g)].map(m => m[1].trim());

      // å¦‚æœæ²¡æœ‰å¤§æ‹¬å·ï¼Œç”¨ä¸‰æ¨ªçº¿æˆ–å…¨æ–‡é€€åŒ–å¤„ç†ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
      if (blocks.length === 0) {
        blocks = raw.split(/\n-{3,}\n/).map(s => s.trim()).filter(Boolean);
      }
      if (blocks.length === 0 && raw.trim().length > 0) {
        blocks = [raw.trim()];
      }

      // å¯¹æ¯ä¸ªå—è§£æ love ä¸ message
      diaryState.weekEntries = Array.from({ length: 7 }, (_, i) => {
        const block = blocks[i] || '';
        const loveMatch = block.match(/love\s*:\s*\(?\s*(\d+)\s*\)?/i);
        const loveVal = loveMatch ? parseInt(loveMatch[1], 10) : 0;

        let messageVal = '';
        // å°è¯•åŒ¹é… message:( ... ) åˆ°å—æœ«å°¾
        const messageMatch = block.match(/message\s*:\s*\(?\s*([\s\S]*?)\s*\)?\s*$/i);
        if (messageMatch) {
          messageVal = messageMatch[1].trim();
        } else {
          const lines = block.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          if (lines.length > 0) {
            if (/^love\s*:/i.test(lines[0])) {
              messageVal = lines.slice(1).join('\n') || 'æš‚æ— æ—¥è®°';
            } else {
              messageVal = lines.join('\n');
            }
          } else {
            messageVal = 'æš‚æ— æ—¥è®°';
          }
        }

        return { score: Math.max(0, loveVal), text: messageVal || 'æš‚æ— æ—¥è®°' };
      });

    } catch (e) {
      diaryState.weekEntries = Array.from({ length: 7 }, () => ({ score: 0, text: 'æš‚æ— æ—¥è®°' }));
      diaryState.lastLoadedRaw = null;
      diaryState.lastRequestedWeek = null;
    }
  }

  function renderDiaryDay() {
    const e = diaryState.weekEntries[diaryState.currentDayIndex] || {score:0,text:'æš‚æ— æ—¥è®°'};
    elements.diaryDayTitle.textContent = WEEKDAY_NAMES[diaryState.currentDayIndex];
    elements.diaryHearts.textContent = `æƒ³è€å©†æŒ‡æ•°ï¼š${'â¤ï¸'.repeat(Math.min(30, Math.max(0, e.score)))}`;
    elements.diaryText.textContent = e.text;
    elements.diaryPrevDay.disabled = diaryState.currentDayIndex === 0;
    elements.diaryNextDay.disabled = diaryState.currentDayIndex === 6;
  }

  function renderDiaryWeekHeader() {
    elements.diaryWeekTitle.textContent = `ç¬¬${diaryState.currentWeek}å‘¨`;
    // æ§åˆ¶ä¸Šä¸€å‘¨æŒ‰é’®ï¼šå½“ week <=1 ç¦ç”¨ä¸Šä¸€å‘¨
    elements.diaryPrevWeek.disabled = diaryState.currentWeek <= 1;
  }

  async function openDiaryModal() {
    diaryState.currentWeek = computeCurrentWeekFromTimer();
    elements.diaryModal.classList.add('active');
    await loadDiaryWeek(diaryState.currentWeek);
    diaryState.currentDayIndex = 0;
    renderDiaryWeekHeader();
    renderDiaryDay();
  }

  function closeDiaryModal() { elements.diaryModal.classList.remove('active'); }

  const CACHE_NAME = 'love-site-v1';
  async function prefetchDiaryFiles() {
    if (!navigator.onLine) return;
    try {
      const cache = await caches.open(CACHE_NAME);
      const last = parseInt(localStorage.getItem('diaryMax') || '0', 10) || 0;
      let i = Math.max(1, last);
      let misses = 0;
      const cap = 500;
      while (i <= cap && misses < 5) {
        const url = `./md/${i}.md`;
        try {
          const resp = await fetch(url, { cache: 'no-store' });
          if (resp.ok) {
            await cache.put(url, resp.clone());
            localStorage.setItem('diaryMax', String(i));
            i++;
            misses = 0;
          } else {
            misses++;
            i++;
          }
        } catch (_) {
          misses++;
          i++;
        }
      }
    } catch (_) {}
  }

  window.addEventListener('load', () => {
    init();
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then((reg) => {
        console.log('Service Worker registered', reg);
      }).catch((err) => {
        console.log('Service Worker registration failed', err);
      });
    }
    prefetchDiaryFiles();
  });
</script>
</body>
</html>
